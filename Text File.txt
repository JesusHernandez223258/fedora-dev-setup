#!/bin/bash

set -e

# Actualizar e instalar repositorios
sudo apt update
sudo apt install -y software-properties-common
sudo add-apt-repository -y main
sudo add-apt-repository -y universe
sudo add-apt-repository -y restricted
sudo add-apt-repository -y multiverse
sudo apt update
sudo apt upgrade -y
sudo apt full-upgrade -y

# Códecs y multimedia
sudo apt install -y ubuntu-restricted-extras
sudo apt install -y gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly \
    gstreamer1.0-libav ffmpeg

# Snap y Flatpak
sudo apt install -y snapd
sudo systemctl enable --now snapd.socket
sudo snap install hello-world
hello-world
sudo apt install -y flatpak gnome-software-plugin-flatpak
flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

# Redes y Bluetooth
sudo apt install -y network-manager wireless-tools wpasupplicant bluez
sudo systemctl enable --now bluetooth.service

# Impresión
sudo apt install -y cups hplip
sudo systemctl enable --now cups
sudo usermod -aG lpadmin $USER

# Compresión
sudo apt install -y zip unzip p7zip-full rar unrar xz-utils tar gzip bzip2

# Desarrollo y herramientas básicas
sudo apt install -y build-essential cmake git curl wget \
    libssl-dev libffi-dev libbz2-dev libreadline-dev libsqlite3-dev zlib1g-dev
sudo apt --fix-broken install

# Diagnóstico y limpieza
sudo apt install -y bleachbit ncdu htop net-tools lsof tree glances
sudo apt install -y ufw
sudo ufw enable
sudo ufw allow OpenSSH
ping -c 4 archive.ubuntu.com

# ZRAM y Zswap
sudo apt install -y zram-tools

echo "# Edita ALGO=zstd y PERCENTAGE=50 en el siguiente archivo"
sleep 2
sudo nano /etc/default/zramswap
sudo systemctl restart zramswap

if [[ "$(cat /sys/module/zswap/parameters/enabled)" != "Y" ]]; then
  echo "# Añade zswap.enabled=1 a GRUB_CMDLINE_LINUX_DEFAULT"
  sleep 2
  sudo nano /etc/default/grub
  sudo update-grub
  echo "Reinicia el sistema para aplicar Zswap"
  read -p "Presiona Enter para reiniciar..."
  sudo reboot
fi

# Swappiness
cat /proc/sys/vm/swappiness
sudo sysctl vm.swappiness=10

echo "# Añade vm.swappiness=10 al final del archivo"
sleep 2
sudo nano /etc/sysctl.conf

# vfs_cache_pressure
sudo sysctl -w vm.vfs_cache_pressure=200
echo "# Añade vm.vfs_cache_pressure=200 al final del archivo"
sleep 2
sudo nano /etc/sysctl.conf

# Limpiar caché
sudo sync
sudo sysctl -w vm.drop_caches=3

# Servicios
systemctl list-unit-files --type=service --state=enabled

# Deshabilitar ejemplo
sudo systemctl disable cups

# Purgar paquetes basura (reemplaza "paquete1 paquete2" con los reales)
sudo apt purge -y paquete1 paquete2 || true
sudo apt autoremove -y
sudo apt clean

# Xorg e i3 básico
sudo apt install -y xserver-xorg xinit xterm
